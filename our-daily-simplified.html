<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Quilt - Simplified</title>
  <style>
    /* ===== RESET & BASE STYLES ===== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    html, body {
      height: 100%;
      width: 100%;
      max-width: 100vw;
      margin: 0;
      padding: 0;
      background-color: #f6f4f1;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: #000;
      line-height: 1.5;
      overflow: hidden;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    /* ===== LAYOUT ===== */
    #app {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      height: 100vh;
      width: 100%;
      max-width: 100vw;
      padding: 0;
      position: relative;
      background-color: #f6f4f1;
      box-sizing: border-box;
      overflow: hidden;

    }

    /* ===== SCREENS ===== */
    .screen {
      display: none; /* Hide by default */
      flex-direction: column;
      width: 100%;
      max-width: 100vw;
      opacity: 0;
      background-color: #f6f4f1;
      pointer-events: none;
      transition: opacity 0.8s ease-in-out;
      position: absolute;
      top: 0; left: 0;
      min-height: 100vh;
      padding: 0.5rem 0 0 0;
      align-items: center;
      justify-content: flex-start;
      box-sizing: border-box;
      overflow-x: hidden;
    }
    
    .screen.active {
      display: flex !important; /* Force display when active */
      opacity: 1;
      pointer-events: auto;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    /* ===== TYPOGRAPHY ===== */
    .portal-header h1 {
      font-weight: 500;
      font-size: clamp(1.8rem, 4vw, 2.5rem);
      margin-bottom: 0.0em;
      letter-spacing:.02em;
    }
    
    .portal-header .quilt-text {
      font-weight: 900;
      font-size: clamp(2.5rem, 6vw, 6rem);
      margin-top: -.5rem;
      margin-bottom: 0.5rem;
      letter-spacing: 0.05em;
    }
    
    .portal-header .date {
      font-weight: 200;
      font-size: clamp(1rem, 2.5vw, 1.4rem);
      margin-top: 0.1rem;
    }
    
    .portal-question {
      font-size: clamp(1.5rem, 3.5vw, 2.2rem);
      font-style: italic;
      font-weight: 200;
      margin: 0;
      max-width: 600px;
      width: 90%;
      animation: fadeInBreath 1.2s ease forwards;
      text-align: center;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    @keyframes fadeInBreath {
      0% {
        opacity: 0;
        transform: translateY(10px);
      }
      50% {
        opacity: 0.8;
        transform: translateY(-2px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    #screen-portal {
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 100vh;
      padding: 2rem 1rem;
      gap: 2rem;
      width: 100%;
      max-width: 100vw;
    }

    /* ===== QUOTE CARD ===== */
    .quote-card {
      border: 2px solid #000;
      border-radius: 16px;
      padding: 1.2rem;
      margin: 1.5rem auto 1.5rem;
      background: #f6f4f1;
      width: 90%;
      max-width: 500px;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      min-height: 120px;
      max-height: 40vh;
    }
    
    .quote-line { 
      font-size: clamp(1rem, 2.8vw, 1.4rem); 
      font-style: italic; 
      font-weight: 300; 
      line-height: 1.4;
    }
    
    .quote-author { 
      font-size: clamp(0.9rem, 2.2vw, 1.1rem); 
      font-weight: 200; 
      margin-top: 0.5rem;
    }
    
    .quote-prompt { 
      font-size: clamp(1.2rem, 3vw, 1.5rem); 
      margin: 2rem 0 1rem; 
    }
    
    .arrow-down {
      font-size: 2rem;
      text-align: center;
      margin: 1rem auto;
    }

    /* ===== COLOR PICKER ===== */
    .color-picker-container { 
      position: relative; 
      margin: 2rem auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: fit-content;
      gap: 1.5rem;
    }
    
    #colorWheelCanvas {
      width: 336px;
      height: 336px;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: transform 0.2s ease;
    }
    
    .css-color-wheel {
      width: 336px;
      height: 336px;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: transform 0.2s ease;
      position: relative;
      background: conic-gradient(
        hsl(25, 100%, 50%),
        hsl(40, 100%, 50%),
        hsl(55, 100%, 50%),
        hsl(70, 100%, 50%),
        hsl(85, 100%, 50%),
        hsl(100, 100%, 50%),
        hsl(115, 100%, 50%),
        hsl(130, 100%, 50%),
        hsl(145, 100%, 50%),
        hsl(160, 100%, 50%),
        hsl(175, 100%, 50%),
        hsl(190, 100%, 50%),
        hsl(205, 100%, 50%),
        hsl(220, 100%, 50%),
        hsl(235, 100%, 50%),
        hsl(250, 100%, 50%),
        hsl(265, 100%, 50%),
        hsl(280, 100%, 50%),
        hsl(295, 100%, 50%),
        hsl(310, 100%, 50%),
        hsl(325, 100%, 50%),
        hsl(340, 100%, 50%),
        hsl(355, 100%, 50%),
        hsl(10, 100%, 50%),
        hsl(25, 100%, 50%)
      );
    }
    
    .css-color-wheel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: radial-gradient(circle, white 0%, transparent 70%);
      pointer-events: none;
    }
    
    .css-color-wheel::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.25);
      pointer-events: none;
    }
    
    #colorWheelCanvas:hover {
      transform: scale(1.02);
    }
    
    #colorWheelCanvas:focus {
      outline: 2px solid #000;
      outline-offset: 4px;
    }
    
    .color-picker-indicator {
      position: absolute;
      width: 20px; height: 20px;
      border-radius: 50%;
      border: 3px solid #fff;
      pointer-events: none;
      transform: translate(-50%, -50%);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    #colorPickerControls {
      display: flex; 
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: 300px;
    }
    
    #valueSlider {
      width: 100%; cursor: pointer; appearance: none;
      height: 30px; border-radius: 15px;
      background: linear-gradient(to right, hsl(0, 90%, 25%), hsl(0, 90%, 85%));
      outline: none; border: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }
    
    #valueSlider::-webkit-slider-thumb {
      width: 24px; height: 24px;
      background: #ffffff !important; border: 1px solid #333;
      border-radius: 50%; cursor: pointer;
      transition: transform 0.1s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      -webkit-appearance: none;
      appearance: none;
    }
    
    #valueSlider::-moz-range-thumb {
      width: 24px; height: 24px;
      background: #ffffff !important; border: 1px solid #333;
      border-radius: 50%; cursor: pointer;
      transition: transform 0.1s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      -moz-appearance: none;
      appearance: none;
    }
    
    #valueSlider::-webkit-slider-thumb:hover,
    #valueSlider::-moz-range-thumb:hover {
      transform: scale(1.1);
    }
    
    #valueSlider::-ms-thumb {
      width: 24px; height: 24px;
      background: #ffffff !important; border: 1px solid #333;
      border-radius: 50%; cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    #selectedColorPreview {
      display: none !important;
    }
    
    #screen-color {
      background-color: #f6f4f1;
      transition: background-color 1.2s cubic-bezier(0.4, 0.0, 0.2, 1);
      justify-content: center;
    }
    
    #screen-quote {
      justify-content: center;
    }
    
    @media (max-width: 768px) {
      #screen-color {
        padding: 0 !important;
        min-height: 100vh !important;
        justify-content: center;
      }
      
      .css-color-wheel {
        width: 224px !important;
        height: 224px !important;
        background: -webkit-conic-gradient(
          hsl(25, 100%, 50%),
          hsl(40, 100%, 50%),
          hsl(55, 100%, 50%),
          hsl(70, 100%, 50%),
          hsl(85, 100%, 50%),
          hsl(100, 100%, 50%),
          hsl(115, 100%, 50%),
          hsl(130, 100%, 50%),
          hsl(145, 100%, 50%),
          hsl(160, 100%, 50%),
          hsl(175, 100%, 50%),
          hsl(190, 100%, 50%),
          hsl(205, 100%, 50%),
          hsl(220, 100%, 50%),
          hsl(235, 100%, 50%),
          hsl(250, 100%, 50%),
          hsl(265, 100%, 50%),
          hsl(280, 100%, 50%),
          hsl(295, 100%, 50%),
          hsl(310, 100%, 50%),
          hsl(325, 100%, 50%),
          hsl(340, 100%, 50%),
          hsl(355, 100%, 50%),
          hsl(10, 100%, 50%),
          hsl(25, 100%, 50%)
        );
        background: conic-gradient(
          hsl(25, 100%, 50%),
          hsl(40, 100%, 50%),
          hsl(55, 100%, 50%),
          hsl(70, 100%, 50%),
          hsl(85, 100%, 50%),
          hsl(100, 100%, 50%),
          hsl(115, 100%, 50%),
          hsl(130, 100%, 50%),
          hsl(145, 100%, 50%),
          hsl(160, 100%, 50%),
          hsl(175, 100%, 50%),
          hsl(190, 100%, 50%),
          hsl(205, 100%, 50%),
          hsl(220, 100%, 50%),
          hsl(235, 100%, 50%),
          hsl(250, 100%, 50%),
          hsl(265, 100%, 50%),
          hsl(280, 100%, 50%),
          hsl(295, 100%, 50%),
          hsl(310, 100%, 50%),
          hsl(325, 100%, 50%),
          hsl(340, 100%, 50%),
          hsl(355, 100%, 50%),
          hsl(10, 100%, 50%),
          hsl(25, 100%, 50%)
        );
      }
    }
    
    /* ===== WELCOME SCREEN ===== */
    .welcome-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    #screen-welcome {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 2rem 1rem;
    }
    
    .welcome-header h1 {
      font-size: 2.5rem;
      font-weight: 900;
      margin-bottom: 0.5rem;
      color: #000;
    }
    
    .welcome-subtitle {
      font-size: 1.2rem;
      color: #666;
      margin: 0;
    }
    
    .welcome-content {
      max-width: 600px;
      margin: 0 auto;
      padding: 0 1rem;
      text-align: left;
    }
    
    .welcome-info h3 {
      font-size: 1.8rem;
      font-weight: 600;
      margin: 1.5rem 0 0.5rem 0;
      color: #000;
    }
    
    .welcome-info h3:first-child {
      margin-top: 0;
    }
    
    .welcome-info p {
      font-size: 1.4rem;
      line-height: 1.8;
      color: #333;
      margin-bottom: 1rem;
    }

    /* ===== QUILT ===== */
    #quilt {
      width: 100vw !important;
      height: 100%;
      max-width: 100vw !important;
      max-height: 100%;
      background: transparent;
      position: relative;
      display: block;
      margin: 0;
      padding: 0;
      border: 3px solid blue !important;
    }
    
    .quilt-container {
      width: 100%;
      height: 100vh;
      position: relative;
      display: flex;
      align-items: stretch;
      justify-content: stretch;
      background: transparent;
      overflow: hidden;
      border: 3px solid red !important;
    }

    /* ===== SQUARE COUNTER ===== */
    .square-counter {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid #000;
      border-radius: 8px;
      font-family: inherit;
    }
    
    .counter-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: #000;
    }
    
    .counter-label {
      font-size: 1rem;
      font-weight: 400;
      color: #333;
      text-transform: lowercase;
    }

    /* ===== BUTTONS ===== */
    .btn {
      background: transparent;
      border: 1px solid #000;
      color: #000 !important;
      padding: 12px 30px;
      border-radius: 999px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      width: auto;
      align-self: center;
      margin: 0.5rem;
      font-family: inherit;
      line-height: 1;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .thank-you-message {
      font-size: clamp(1.3rem, 3.5vw, 1.8rem);
      text-align: center;
      margin: 1rem 0 2rem 0;
      font-weight: 300;
      line-height: 1.4;
    }
    
    #shareBtnCompleted {
      margin-bottom: 4rem;
    }
    
    .btn:hover { 
      background: #000; color: #000 !important; 
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .btn:focus {
      outline: 2px solid #000;
      outline-offset: 2px;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* ===== ANIMATIONS ===== */
    .new-block {
      transform-origin: center;
      animation: scaleUpSpring 2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    @keyframes scaleUpSpring {
      0% { transform: scale(0); opacity: 0; }
      40% { transform: scale(0.8); opacity: 0; }
      60% { transform: scale(1.05); opacity: 1; }
      80% { transform: scale(0.98); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .quilt-block {
      background-image: 
        radial-gradient(circle at 25% 25%, rgba(255,255,255,0.1) 1px, transparent 1px),
        radial-gradient(circle at 75% 75%, rgba(0,0,0,0.05) 1px, transparent 1px);
      background-size: 8px 8px, 12px 12px;
      background-position: 0 0, 4px 4px;
    }

    /* ===== LOADING ===== */
    .loading {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(246, 244, 241, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .loading.show {
      opacity: 1;
      visibility: visible;
    }
    
    .loading-spinner {
      width: 40px; height: 40px;
      border: 3px solid #f6f4f1;
      border-top: 3px solid #000;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ===== TOAST ===== */
    .toast {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: #fff; padding: 12px 24px;
      border-radius: 24px;
      opacity: 0; transition: opacity 0.3s ease;
      pointer-events: none; font-size: 0.9rem;
      font-weight: 500;
      z-index: 1001;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .toast.show { opacity: 1; }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      html, body {
        overflow: hidden !important;
        position: fixed !important;
        width: 100% !important;
        height: 100% !important;
        -webkit-overflow-scrolling: touch;
      }
      
      #app {
        overflow: hidden !important;
        height: 100% !important;
        width: 100% !important;
      }
      
      .screen { 
        padding: 2rem 1rem 0 1rem; 
        width: 100vw;
        max-width: 100vw;
        box-sizing: border-box;
      }
      
      .portal-question {
        width: 100%;
        max-width: 100%;
        padding: 0 1rem;
        box-sizing: border-box;
      }
      .quote-card { width: 95%; padding: 1rem; }
      .css-color-wheel { 
        width: 288px; 
        height: 288px; 
      }
      .quilt-container {
        width: 100% !important;
        max-width: 100vw !important;
        height: 100vh !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        z-index: 1;
        display: flex !important;
        align-items: stretch !important;
        justify-content: stretch !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        margin: 0 !important;
        padding: 0 !important;
        border: 3px solid red !important;
        background-color: rgba(255, 0, 0, 0.1) !important;
      }
      
      #quilt { 
        width: 100% !important; 
        height: 100% !important; 
        max-width: 100% !important;
        max-height: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        display: block !important;
        position: relative !important;
      }
      

      
      /* Square counter styling for quilt screen */
      #screen-quilt .square-counter {
        background: #fff !important;
        border: 2px solid #000 !important;
        margin: 1rem 0.5rem 0.5rem 0.5rem !important;
        padding: 0.5rem !important;
        border-radius: 6px !important;
      }
      
      #screen-quilt .counter-number {
        font-size: 1.3rem !important;
        font-weight: 700 !important;
      }
      
      #screen-quilt .counter-label {
        font-size: 0.9rem !important;
      }
      
      /* Quilt screen button styling - QUILT SCREEN ONLY */
      #screen-quilt .btn {
        background: #fff !important;
        border: 2px solid #000 !important;
        color: #000 !important;
        font-size: 0.9rem !important;
        padding: 8px 16px !important;
        margin: 0.5rem !important;
        display: block !important;
        width: 100% !important;
        max-width: none !important;
      }
      
      /* Reset button styling for other screens */
      #screen-portal .btn,
      #screen-welcome .btn,
      #screen-quote .btn,
      #screen-color .btn,
      #screen-archive .btn,
      #screen-about .btn {
        background: transparent !important;
        border: 1px solid #000 !important;
        font-size: 1rem !important;
        padding: 12px 30px !important;
        margin: 0.5rem !important;
        display: inline-block !important;
        width: auto !important;
        max-width: none !important;
      }
      
      #screen-quilt {
        padding: 0 !important;
        margin: 0 !important;
        justify-content: flex-start !important;
        align-items: stretch !important;
        min-height: 100vh !important;
        height: 100vh !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100% !important;
        max-width: 100vw !important;
        border: 3px solid green !important;
        background-color: rgba(0, 255, 0, 0.1) !important;
        box-sizing: border-box !important;
      }
      
      /* Fixed height screens - NO SCROLLING */
      #screen-portal,
      #screen-welcome,
      #screen-quote,
      #screen-color {
        padding: 1rem !important;
        justify-content: center !important;
        align-items: center !important;
        height: 100vh !important;
        min-height: 100vh !important;
        max-height: 100vh !important;
        overflow: hidden !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        box-sizing: border-box !important;
      }
      
      /* Quilt screen - CAN SCROLL */
      #screen-quilt {
        padding: 0 !important;
        justify-content: flex-start !important;
        align-items: stretch !important;
        min-height: 100vh !important;
        height: auto !important;
        max-height: none !important;
        overflow-y: auto !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
      }
      
      /* Archive screen - CAN SCROLL */
      #screen-archive {
        padding: 3rem 0 10px 0 !important;
        justify-content: flex-start !important;
        align-items: center !important;
        min-height: 100vh !important;
        height: auto !important;
        max-height: none !important;
        overflow-y: auto !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
      }
      
      /* About screen - FIXED HEIGHT */
      #screen-about {
        padding: 3rem 0 10px 0 !important;
        justify-content: center !important;
        align-items: center !important;
        height: 100vh !important;
        min-height: 100vh !important;
        max-height: 100vh !important;
        overflow: hidden !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
      }
      
      /* Button container that sits below the full-screen quilt - QUILT SCREEN ONLY */
      #screen-quilt .button-container {
        position: relative !important;
        background: #f6f4f1 !important;
        padding: 1rem !important;
        border-top: 2px solid #000 !important;
        margin-top: 100vh !important;
        border: 3px solid orange !important;
      }
      
      /* Ensure other screens don't have button container styling */
      #screen-portal .button-container,
      #screen-welcome .button-container,
      #screen-quote .button-container,
      #screen-color .button-container,
      #screen-archive .button-container,
      #screen-about .button-container {
        position: static !important;
        background: transparent !important;
        padding: 0 !important;
        border-top: none !important;
        margin-top: 0 !important;
      }
      

      

      
      #screen-quilt .thank-you-message {
        margin-bottom: 0.5rem;
        z-index: 10;
        position: relative;
      }
      
      #screen-quilt .btn {
        margin: 0.5rem;
        z-index: 10;
        position: relative;
      }
    }
    
    @media (max-width: 480px) {
      html, body {
        overflow: hidden !important;
        position: fixed !important;
        width: 100vw !important;
        height: 100vh !important;
        -webkit-overflow-scrolling: touch;
      }
      
      #app {
        overflow: hidden !important;
        height: 100vh !important;
        width: 100vw !important;
      }
      
      .portal-header h1 { font-size: 2rem; }
      .portal-question { font-size: 1.8rem; margin: 1rem 0 3rem; }
      .css-color-wheel { 
        width: 240px; 
        height: 240px; 
      }
      #colorPickerControls { flex-direction: column; gap: 10px; }
      
      .quilt-container {
        width: 100% !important;
        max-width: 100vw !important;
        height: 100vh !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        z-index: 1;
        display: flex !important;
        align-items: stretch !important;
        justify-content: stretch !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        margin: 0 !important;
        padding: 0 !important;
        border: 3px solid red !important;
        background-color: rgba(255, 0, 0, 0.1) !important;
      }
      
      #quilt { 
        width: 100% !important; 
        height: 100% !important; 
        max-width: 100% !important;
        max-height: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        display: block !important;
        position: relative !important;
      }
      
      #screen-quilt .thank-you-message {
        font-size: 1rem;
        margin-bottom: 0.3rem;
      }
      
      /* Fixed height screens for smaller mobile - NO SCROLLING */
      #screen-portal,
      #screen-welcome,
      #screen-quote,
      #screen-color {
        padding: 0.5rem !important;
        height: 100vh !important;
        min-height: 100vh !important;
        max-height: 100vh !important;
        overflow: hidden !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        box-sizing: border-box !important;
      }
    }

    /* ===== FLOATING ADMIN BUTTON ===== */
    .floating-admin-btn {
      position: fixed !important;
      bottom: 20px !important;
      right: 20px !important;
      width: 50px !important;
      height: 50px !important;
      border-radius: 50% !important;
      background: #f6f4f1 !important;
      color: #000 !important;
      border: none !important;
      font-size: 20px !important;
      cursor: pointer !important;
      z-index: 1000 !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
      transition: all 0.3s ease !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    .floating-admin-btn:hover {
      transform: scale(1.1) !important;
      box-shadow: 0 6px 12px rgba(0,0,0,0.4) !important;
    }

    .floating-admin-btn:active {
      transform: scale(0.95) !important;
    }

    /* ===== ACCESSIBILITY ===== */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      .new-block { animation: none; }
    }
    
    /* ===== MOBILE SCROLL PREVENTION ===== */
    @media (max-width: 768px) {
      * {
        -webkit-overflow-scrolling: touch;
      }
      
      .screen {
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: none;
      }
    }
    
    @media (prefers-contrast: high) {
      .btn { border-width: 2px; }
      .quote-card { border-width: 3px; }
    }

    /* ===== ARCHIVE SCREEN ===== */
    .archive-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .archive-header h1 {
      font-size: 2.5rem;
      font-weight: 900;
      margin-bottom: 0.5rem;
      color: #000;
    }
    
    .archive-subtitle {
      font-size: 1.2rem;
      color: #666;
      margin: 0;
    }
    
    .archive-feed {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    
    .archive-load-more {
      margin: 2rem auto;
      display: block;
      background: #666;
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 24px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    
    .archive-load-more:hover {
      background: #333;
    }
    
    .archive-load-more:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .archive-loading {
      text-align: center;
      padding: 2rem;
      color: #666;
      font-style: italic;
    }

    /* ===== ABOUT SCREEN ===== */
    .about-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .about-header h1 {
      font-size: 2.5rem;
      font-weight: 900;
      margin-bottom: 0.5rem;
      color: #000;
    }
    
    .about-subtitle {
      font-size: 1.2rem;
      color: #666;
      margin: 0;
    }
    
    .about-content {
      max-width: 600px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    
    .about-description {
      font-size: 1.1rem;
      line-height: 1.6;
      color: #333;
      margin-bottom: 2rem;
      text-align: center;
    }
    
    .about-info h3 {
      font-size: 1.3rem;
      font-weight: 600;
      margin: 1.5rem 0 0.5rem 0;
      color: #000;
    }
    
    .about-info h3:first-child {
      margin-top: 0;
    }
    
    .about-info p {
      font-size: 1.1rem;
      line-height: 1.6;
      color: #333;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <main id="app">
    <!-- Portal Screen -->
    <section class="screen active" id="screen-portal" role="main" aria-label="Welcome screen">
      <div class="portal-header">
        <h1>OUR DAILY</h1>
        <h1 class="quilt-text">QUILT</h1>
        <p class="date" id="date-text" aria-live="polite"></p>
      </div>
      <p class="portal-question">What if today started with just one good thought?</p>
    </section>

    <!-- Welcome Screen (First Time Only) -->
    <section class="screen" id="screen-welcome" role="main" aria-label="Welcome to Our Daily">
      <div class="welcome-header">
        <h1>WELCOME TO OUR DAILY</h1>
        <p class="welcome-subtitle">A collaborative community quilt</p>
      </div>
      
      <div class="welcome-content">
        <div class="welcome-info">
          <h3>Here's how it works:</h3>
          <p>1. Read a quote<br>
          2. Choose a color<br>
          3. Help build a growing community quilt</p>
          
          <p><strong>New quote and quilt everyday!</strong></p>
        </div>
      </div>
      
      <button class="btn" data-next="screen-quote" aria-label="Get started">Get Started</button>
    </section>

    <!-- Quote Screen -->
    <section class="screen" id="screen-quote" role="main" aria-label="Daily quote screen">
      <div class="quote-card">
        <div class="quote-inner">
          <p class="quote-line" aria-live="polite"></p>
          <p class="quote-author" aria-live="polite"></p>
        </div>
      </div>
      <p class="quote-prompt">What color comes to mind when you read this?</p>
      <div class="arrow-down">‚Üì</div>
      <button class="btn" data-next="screen-color" aria-label="Add your color to the quilt">ADD YOUR COLOR</button>
    </section>

    <!-- Color Picker Screen -->
    <section class="screen" id="screen-color" role="main" aria-label="Color picker screen">
      <div class="color-picker-container">
        <div class="css-color-wheel" id="colorWheelCanvas" role="button" tabindex="0" aria-label="Color wheel - click or drag to select hue"></div>
        <div class="color-picker-indicator" id="colorIndicator" aria-hidden="true"></div>
        <div id="colorPickerControls">
          <input type="range" id="valueSlider" min="25" max="90" value="50" aria-label="Adjust color brightness" />
        </div>
      </div>
      <button class="btn" id="addColorBtn" aria-label="Add selected color to the community quilt">ADD COLOR TO QUILT</button>
    </section>

    <!-- Quilt Screen -->
    <section class="screen" id="screen-quilt" role="main" aria-label="Community quilt display">
      <!-- Quilt container -->
      <div class="quilt-container">
        <svg id="quilt" viewBox="0 0 1000 1000" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Community quilt with colorful blocks"></svg>
      </div>
      
      <!-- Button container -->
      <div class="button-container">
        <!-- Square counter -->
        <div class="square-counter">
          <span class="counter-number" id="squareCounter">1</span>
          <span class="counter-label">squares</span>
        </div>
        
        <div class="button-group">
          <button id="testAddBlock" class="btn" style="background: #ff6b6b; color: white;">TEST: ADD RANDOM BLOCK</button>
          <button id="showMyPieceBtn" class="btn" style="background: #4CAF50; color: white;">SHOW ME MY PIECE</button>
          <button id="testDifferentUserBtn" class="btn" style="background: #9C27B0; color: white;">TEST: Simulate Different User</button>
        </div>
        
        <div class="button-group">
          <button id="shareBtnCompleted" class="btn" aria-label="Share this community quilt">Share This Quilt</button>
          <button class="btn" data-next="screen-archive" aria-label="View quilt archive">View Archive</button>
          <button class="btn" data-next="screen-about" aria-label="About this project">About</button>
        </div>
      </div>
    </section>

    <!-- Archive Screen -->
    <section class="screen" id="screen-archive" role="main" aria-label="Quilt archive">
      <div class="archive-header">
        <h1>QUILT ARCHIVE</h1>
        <p class="archive-subtitle">Past community quilts</p>
      </div>
      
      <!-- Archive Feed -->
      <div class="archive-feed" id="archiveFeed">
        <!-- Archive posts will be dynamically inserted here -->
      </div>
      
      <!-- Load More Button -->
      <button class="btn archive-load-more" id="archiveLoadMore" style="display: none;">Load More</button>
      
      <!-- Loading Indicator -->
      <div class="archive-loading" id="archiveLoading" style="display: none;">
        <p>Loading quilts...</p>
      </div>
      
      <!-- Back Button -->
      <button class="btn" data-next="screen-quilt" aria-label="Back to current quilt">Back to Quilt</button>
    </section>

    <!-- About Screen -->
    <section class="screen" id="screen-about" role="main" aria-label="About this project">
      <div class="about-header">
        <h1>ABOUT OUR DAILY</h1>
        <p class="about-subtitle">A collaborative community quilt</p>
      </div>
      
      <div class="about-content">
        <p class="about-description">This is a daily collaborative art project where people from around the world contribute colors to create a community quilt.</p>
        
        <div class="about-info">
          <h3>How it works</h3>
          <p>Each day, participants read an inspiring quote and choose a color that speaks to them. These colors become blocks in our community quilt.</p>
          
          <h3>Community</h3>
          <p>Every color represents a person, a moment, a feeling. Together we create something beautiful that grows with each contribution.</p>
          
          <h3>Share</h3>
          <p>Download your quilt block or the entire community quilt to share with others and inspire them to join in.</p>
        </div>
      </div>
      
      <button class="btn" data-next="screen-quilt" aria-label="Back to current quilt">Back to Quilt</button>
    </section>
  </main>

  <!-- Loading indicator -->
  <div id="loading" class="loading" aria-hidden="true">
    <div class="loading-spinner"></div>
    <p>Loading...</p>
  </div>

  <!-- Toast notifications -->
  <div id="toast" class="toast" role="alert" aria-live="polite"></div>

  <!-- Floating Admin Button -->
  <button id="floatingAdminBtn" class="floating-admin-btn" aria-label="Admin controls" style="display: none;">
    ‚öôÔ∏è
  </button>

  <!-- External dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script type="module">
    // ===== CONFIGURATION =====
    const CONFIG = {
      APP: {
        name: 'Our Daily',
        version: '2.0.0-simplified',
        defaultColor: '#f7b733',
        quiltSize: 1000, // Base size for calculations

        animationDuration: 2000,
        toastDuration: 3000,
        debugMode: true
      },
      FIREBASE: {
        apiKey: "AIzaSyBqMJlchU_luM5-XcPo0USDUjsM60Qfoqg",
        authDomain: "our-daily.firebaseapp.com",
        projectId: "our-daily",
        storageBucket: "our-daily.firebasestorage.app",
        messagingSenderId: "337201931314",
        appId: "1:337201931314:web:fb5677846d03eb285ac82b",
        measurementId: "G-65XB7QC1F4"
      },
      COLOR_PICKER: {
        wheelSize: 280,
        defaultHue: 45,
        defaultLightness: 62.5,
        saturation: 65
      },
      QUILT: {
        viewBoxWidth: 800,
        viewBoxHeight: 800,
        gridCols: 8,
        gridRows: 8,
        blockSpacing: 4,
        blockPadding: 2
      }
    };

    // ===== UTILITY FUNCTIONS =====
    class Utils {
      static hslToHex(h, s, l) {
        h /= 360;
        s /= 100;
        l /= 100;
        
        const hue2rgb = (p, q, t) => {
          if (t < 0) t += 1;
          if (t > 1) t -= 1;
          if (t < 1/6) return p + (q - p) * 6 * t;
          if (t < 1/2) return q;
          if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
          return p;
        };
        
        let r, g, b;
        
        if (s === 0) {
          r = g = b = l;
        } else {
          const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
          const p = 2 * l - q;
          r = hue2rgb(p, q, h + 1/3);
          g = hue2rgb(p, q, h);
          b = hue2rgb(p, q, h - 1/3);
        }
        
        const toHex = (c) => {
          const hex = Math.round(c * 255).toString(16);
          return hex.length === 1 ? '0' + hex : hex;
        };
        
        return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
      }

      static validateHexColor(color) {
        const hexRegex = /^#[0-9A-F]{6}$/i;
        return hexRegex.test(color);
      }

      static getOrCreateUserId() {
        let userId = localStorage.getItem('ourDailyUserId');
        if (!userId) {
          userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          localStorage.setItem('ourDailyUserId', userId);
        }
        return userId;
      }

      static getTodayKey() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      static getQuiltDimensions() {
        // Comprehensive viewport detection for mobile devices
        const hasVisualViewport = window.visualViewport && window.visualViewport.width > 0;
        const hasDynamicViewport = CSS.supports('height', '1dvh');
        
        let screenWidth, screenHeight;
        let detectionMethod = 'unknown';
        
        if (hasVisualViewport) {
          // Method 1: Visual Viewport API (most accurate)
          screenWidth = window.visualViewport.width;
          screenHeight = window.visualViewport.height;
          
          // Use visual viewport directly - better to scroll than clip
          // No safety margin - let the quilt use full available space
          
          detectionMethod = 'visualViewport';
        } else {
          // Method 2: Try to measure actual visible area
          const body = document.body;
          const html = document.documentElement;
          
          // Get the actual rendered dimensions
          const bodyRect = body.getBoundingClientRect();
          const htmlRect = html.getBoundingClientRect();
          
          // Use the smaller of the two (more likely to be accurate)
          const measuredWidth = Math.min(bodyRect.width, htmlRect.width);
          const measuredHeight = Math.min(bodyRect.height, htmlRect.height);
          
          if (measuredWidth > 0 && measuredHeight > 0) {
            screenWidth = measuredWidth;
            screenHeight = measuredHeight;
            detectionMethod = 'getBoundingClientRect';
          } else {
            // Method 3: Fallback to inner dimensions with safety margin
            screenWidth = window.innerWidth;
            screenHeight = window.innerHeight;
            
            // Apply safety margin for browser UI
            const browserUIMargin = Math.min(screenHeight * 0.15, 120); // 15% or 120px max
            screenHeight = screenHeight - browserUIMargin;
            detectionMethod = 'innerDimensionsWithMargin';
          }
        }
        
        const isMobile = screenWidth <= 768;
        

        
        if (isMobile) {
          // On mobile, use the most accurate viewport available
          const dimensions = {
            width: screenWidth,
            height: screenHeight,
            viewBoxWidth: screenWidth,
            viewBoxHeight: screenHeight
          };

          return dimensions;
        } else {
          // On desktop, use a square that fits the screen
          const maxSize = Math.min(screenWidth * 0.8, screenHeight * 0.8);
          const dimensions = {
            width: maxSize,
            height: maxSize,
            viewBoxWidth: maxSize,
            viewBoxHeight: maxSize
          };

          return dimensions;
        }
      }

      static formatDate(date = new Date()) {
        return date.toLocaleDateString(undefined, {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      }
    }

    // ===== LOGGING SERVICE =====
    class Logger {
      constructor(debugMode = CONFIG.APP.debugMode) {
        this.debugMode = debugMode;
        this.prefix = 'üßµ';
      }

      log(message, data = null) {
        if (this.debugMode) {
          console.log(`${this.prefix} ${message}`, data || '');
        }
      }

      warn(message, data = null) {
        if (this.debugMode) {
          console.warn(`${this.prefix} ‚ö†Ô∏è ${message}`, data || '');
        }
      }

      error(message, error = null) {
        console.error(`${this.prefix} ‚ùå ${message}`, error || '');
      }
    }

    // ===== UI SERVICE =====
    class UIService {
      constructor(logger) {
        this.logger = logger;
      }

      showToast(message, duration = CONFIG.APP.toastDuration) {
        const toast = document.getElementById('toast');
        if (!toast) return;
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), duration);
      }

      showLoading(show = true) {
        const loading = document.getElementById('loading');
        if (!loading) return;
        if (show) {
          loading.classList.add('show');
        } else {
          loading.classList.remove('show');
        }
      }

      showScreen(screenId) {
        try {
          // Remove active class from all screens
          document.querySelectorAll(".screen").forEach(s => {
            s.classList.remove("active");
            s.style.display = 'none'; // Ensure screens are hidden
          });
          
          const target = document.getElementById(screenId);
          if (target) {
            // Show the target screen
            target.style.display = 'flex';
            target.classList.add("active");
            
            // Force a reflow to ensure the screen is visible
            target.offsetHeight;
            
            if (screenId === 'screen-color') {
              const colorScreen = document.getElementById('screen-color');
              if (colorScreen) {
                colorScreen.style.backgroundColor = '#f6f4f1';
              }
            }
            
            // Reset scroll positions
            window.scrollTo(0, 0);
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
            
            const app = document.getElementById('app');
            if (app) {
              app.scrollTop = 0;
            }
          } else {
            this.logger.error(`‚ùå Screen not found: ${screenId}`);
            // Fallback to portal screen
            this.showScreen('screen-portal');
          }
        } catch (error) {
          this.logger.error(`‚ùå Error switching to screen ${screenId}:`, error);
          // Emergency fallback
          const portalScreen = document.getElementById('screen-portal');
          if (portalScreen) {
            document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
            portalScreen.classList.add("active");
            portalScreen.style.display = 'flex';
          }
        }
      }
    }

    // ===== ERROR HANDLING SERVICE =====
    class ErrorHandler {
      constructor(uiService, logger) {
        this.uiService = uiService;
        this.logger = logger;
      }

      handleError(error, context = 'Unknown') {
        this.logger.error(`Error in ${context}:`, error);
        
        const errorMessages = {
          'loadQuilt': 'Failed to load quilt data. Starting fresh.',
          'saveQuilt': 'Failed to save your color. Please try again.',
          'shareFlow': 'Failed to create share image. Saving instead.',
          'colorPicker': 'Color picker error. Please try again.',
          'App initialization': 'Failed to initialize app. Please refresh.',
          'renderQuilt': 'Failed to render quilt. Please try again.',
          'addColorToQuilt': 'Failed to add color. Please try again.'
        };
        
        const message = errorMessages[context] || 'Something went wrong. Please try again.';
        this.uiService.showToast(message);
      }

      validateColor(color) {
        if (!Utils.validateHexColor(color)) {
          throw new Error(`Invalid color format: ${color}`);
        }
        return true;
      }
    }

    // ===== DATA LAYER =====
    class QuiltDataService {
      constructor(logger, errorHandler) {
        this.logger = logger;
        this.errorHandler = errorHandler;
        this.db = null;
        this.quiltDoc = null;
      }

      async initialize() {
        // Firebase temporarily disabled
        this.db = null;
        this.quiltDoc = null;
      }

      async loadQuilt() {
        // Firebase temporarily disabled - try localStorage first
        try {
          const savedData = localStorage.getItem('ourDailyQuilt');
          if (savedData) {
            const data = JSON.parse(savedData);
            return { 
              blocks: data.blocks || [], 
              contributorCount: data.contributorCount || 1 
            };
          }
        } catch (error) {
          // Fall through to default
        }
        
        // Return default quilt if no saved data
        const dimensions = Utils.getQuiltDimensions();
        return { 
          blocks: [{ x: 0, y: 0, width: dimensions.width, height: dimensions.height, color: CONFIG.APP.defaultColor }], 
          contributorCount: 1 
        };
      }

      async saveQuilt(blocks, contributorCount) {
        // Firebase temporarily disabled - save to localStorage only
        try {
          localStorage.setItem('ourDailyQuilt', JSON.stringify({
            blocks: blocks,
            contributorCount: contributorCount,
            lastUpdated: new Date().toISOString(),
            date: new Date().toISOString().split('T')[0]
          }));
          return true;
        } catch (error) {
          this.errorHandler.handleError(error, 'saveQuilt');
          return false;
        }
      }
    }

    // ===== QUOTE SERVICE =====
    class QuoteService {
      constructor() {
        this.quotes = [
          { text: "Art washes away from the soul the dust of everyday life.", author: "‚Äî Pablo Picasso" },
          { text: "Creativity takes courage.", author: "‚Äî Henri Matisse" },
          { text: "Every artist was first an amateur.", author: "‚Äî Ralph Waldo Emerson" },
          { text: "Color is the keyboard, the eyes are the harmonies, the soul is the piano with many strings.", author: "‚Äî Wassily Kandinsky" },
          { text: "Great things are done by a series of small things brought together.", author: "‚Äî Vincent Van Gogh" },
          { text: "You can't use up creativity. The more you use, the more you have.", author: "‚Äî Maya Angelou" }
        ];
        this.shuffledIndexes = [2, 4, 0, 5, 3, 1];
      }

      getTodayQuote() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const todayString = `${year}-${month}-${day}`;
        const dayIndex = Math.floor(new Date(todayString).getTime() / (1000 * 60 * 60 * 24));
        const quoteIndex = this.shuffledIndexes[dayIndex % this.shuffledIndexes.length];
        return this.quotes[quoteIndex];
      }

      displayQuote() {
        try {
          const { text, author } = this.getTodayQuote();
          const quoteLine = document.querySelector('.quote-line');
          const quoteAuthor = document.querySelector('.quote-author');
          
          if (quoteLine) quoteLine.textContent = text;
          if (quoteAuthor) quoteAuthor.textContent = author;
        } catch (error) {
          console.error('Error displaying quote:', error);
        }
      }
    }

    // ===== BLOCK-BASED QUILT RENDERER =====
    class BlockQuiltRenderer {
      constructor(logger) {
        this.logger = logger;
        this.quiltSVG = null;
        this.lastAddedIndex = null;
      }

      initialize() {
        this.quiltSVG = document.getElementById('quilt');
        if (!this.quiltSVG) {
          throw new Error('Quilt SVG element not found');
        }

      }

      renderBlocks(blocks) {
        if (!this.quiltSVG) {
          this.logger.warn('Quilt SVG not found');
          return;
        }



        // Clear existing content
        this.quiltSVG.innerHTML = '';

        if (blocks.length === 0) {
          return;
        }

        // Calculate quilt bounds and apply scaling
        const minX = Math.min(...blocks.map(b => b.x));
        const minY = Math.min(...blocks.map(b => b.y));
        const maxX = Math.max(...blocks.map(b => b.x + b.width));
        const maxY = Math.max(...blocks.map(b => b.y + b.height));
        
        const quiltWidth = maxX - minX;
        const quiltHeight = maxY - minY;
        
        // Get scale factor from app (or default to 1)
        const scale = window.app?.quiltScale || 1;
        
        // Calculate scaled dimensions
        const scaledWidth = quiltWidth * scale;
        const scaledHeight = quiltHeight * scale;
        
        // Set SVG dimensions to match the actual quilt size
        this.quiltSVG.setAttribute('viewBox', `${minX} ${minY} ${quiltWidth} ${quiltHeight}`);
        this.quiltSVG.setAttribute('width', scaledWidth);
        this.quiltSVG.setAttribute('height', scaledHeight);
        this.quiltSVG.setAttribute('preserveAspectRatio', 'xMidYMid meet');
        
        // Set CSS to match SVG dimensions
        this.quiltSVG.style.width = `${scaledWidth}px`;
        this.quiltSVG.style.height = `${scaledHeight}px`;
        this.quiltSVG.style.maxWidth = '100%';
        this.quiltSVG.style.maxHeight = '100%';
        


        // Add SVG definitions for effects
        const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        defs.innerHTML = `
          <filter id="dropShadow" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="2" dy="4" stdDeviation="3" flood-color="rgba(0,0,0,0.15)"/>
          </filter>
          <filter id="watercolorTexture" x="0" y="0" width="100%" height="100%">
            <feTurbulence baseFrequency="0.3" numOctaves="2" result="noise" type="fractalNoise"/>
            <feColorMatrix type="matrix" values="1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0.1 0" in="noise" result="texture"/>
            <feBlend mode="multiply" in="SourceGraphic" in2="texture"/>
          </filter>
        `;
        this.quiltSVG.appendChild(defs);



        // Render each block
        blocks.forEach((block, i) => {
          // Add jittered positioning for organic feel
          const jitterX = (Math.random() - 0.5) * 6;
          const jitterY = (Math.random() - 0.5) * 6;
          const jitterRotation = (Math.random() - 0.5) * 3;
          
          // Apply scale factor to block dimensions
          const scale = window.app?.quiltScale || 1;
          const jitteredBlock = {
            x: block.x + jitterX,
            y: block.y + jitterY,
            width: block.width,
            height: block.height,
            color: block.color,
            rotation: jitterRotation
          };
          
          // Create simple rectangle with jitter
          const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          rect.setAttribute('x', jitteredBlock.x);
          rect.setAttribute('y', jitteredBlock.y);
          rect.setAttribute('width', jitteredBlock.width);
          rect.setAttribute('height', jitteredBlock.height);
          rect.setAttribute('fill', jitteredBlock.color);
          
          // Apply rotation transform
          const centerX = jitteredBlock.x + jitteredBlock.width / 2;
          const centerY = jitteredBlock.y + jitteredBlock.height / 2;
          rect.setAttribute('transform', `rotate(${jitteredBlock.rotation} ${centerX} ${centerY})`);
          
          // Add animation for new blocks
          if (i === this.lastAddedIndex) {
            rect.setAttribute('opacity', '0');
            rect.classList.add('new-block');
            rect.addEventListener('animationend', () => {
              rect.classList.remove('new-block');
              rect.removeAttribute('opacity');
            }, { once: true });
          }
          
          this.quiltSVG.appendChild(rect);
        });

        this.lastAddedIndex = null;

      }





      setLastAddedIndex(index) {
        this.lastAddedIndex = index;
      }
    }

    // ===== MAIN APPLICATION =====
    class SimplifiedQuiltApp {
      constructor() {
        // Initialize services
        this.logger = new Logger(CONFIG.APP.debugMode);
        this.uiService = new UIService(this.logger);
        this.errorHandler = new ErrorHandler(this.uiService, this.logger);
        this.dataService = new QuiltDataService(this.logger, this.errorHandler);
        this.quoteService = new QuoteService();
        this.renderer = new BlockQuiltRenderer(this.logger);
        
        // App state - now using blocks instead of colors
        const dimensions = Utils.getQuiltDimensions();
        this.blocks = [{ x: 0, y: 0, width: dimensions.width, height: dimensions.height, color: CONFIG.APP.defaultColor }];
        this.contributorCount = 1;
        this.currentUserId = Utils.getOrCreateUserId();
        
        // Color picker state
        this.selectedHue = CONFIG.COLOR_PICKER.defaultHue;
        this.selectedSaturation = CONFIG.COLOR_PICKER.saturation;
        this.selectedLightness = CONFIG.COLOR_PICKER.defaultLightness;
        this.colorHasBeenSelected = false;
        
        // Scaling state
        this.quiltScale = 1;
        

      }

      async initialize() {
        try {
          
          // Ensure portal screen is visible during initialization
          this.uiService.showScreen('screen-portal');
          
          await this.dataService.initialize();
          this.setupEventListeners();
          this.initializeUI();
          await this.loadQuilt();
          
          this.renderer.initialize();
          this.renderQuilt();
          this.updateSquareCounter();
          
          // Auto-transition from portal screen after delay
          this.setupAutoTransition();
          
        } catch (error) {
          this.errorHandler.handleError(error, 'App initialization');
          // Ensure portal screen is still visible even if initialization fails
          this.uiService.showScreen('screen-portal');
        }
      }

      setupEventListeners() {
        // Navigation
        document.querySelectorAll(".btn[data-next]").forEach(btn => {
          btn.addEventListener("click", e => {
            e.preventDefault();
            const targetId = btn.getAttribute("data-next");
            if (targetId) this.uiService.showScreen(targetId);
          });
        });

        // Add color button
        const addColorBtn = document.getElementById('addColorBtn');
        if (addColorBtn) {
          addColorBtn.addEventListener('click', this.handleAddColor.bind(this));
        }

        // Share button
        const shareBtnCompleted = document.getElementById('shareBtnCompleted');
        if (shareBtnCompleted) {
          shareBtnCompleted.addEventListener('click', this.handleShare.bind(this));
        }

        // Test buttons
        const testAddBlock = document.getElementById('testAddBlock');
        if (testAddBlock) {
          testAddBlock.addEventListener('click', this.handleTestAddBlock.bind(this));
        }

        const showMyPieceBtn = document.getElementById('showMyPieceBtn');
        if (showMyPieceBtn) {
          showMyPieceBtn.addEventListener('click', this.handleShowMyPiece.bind(this));
        }

        const testDifferentUserBtn = document.getElementById('testDifferentUserBtn');
        if (testDifferentUserBtn) {
          testDifferentUserBtn.addEventListener('click', this.handleTestDifferentUser.bind(this));
        }

        // Color picker
        this.setupColorPicker();

        // Keyboard navigation
        document.addEventListener('keydown', this.handleKeyDown.bind(this));
        
        // Window resize handler
        window.addEventListener('resize', this.handleWindowResize.bind(this));
        
        // Visual viewport resize handler (for mobile browser UI changes)
        if (window.visualViewport) {
          window.visualViewport.addEventListener('resize', this.handleWindowResize.bind(this));
        }
        
        // Floating admin button
        this.setupFloatingAdminButton();
      }

      setupColorPicker() {
        const colorWheel = document.getElementById('colorWheelCanvas');
        const indicator = document.getElementById('colorIndicator');
        const valueSlider = document.getElementById('valueSlider');

        if (colorWheel) {
          // Mouse events for CSS color wheel
          colorWheel.addEventListener('mousedown', this.handleColorWheelMouseDown.bind(this));
          colorWheel.addEventListener('mousemove', this.handleColorWheelMouseMove.bind(this));
          colorWheel.addEventListener('mouseup', this.handleColorWheelMouseUp.bind(this));
          
          // Touch events for CSS color wheel
          colorWheel.addEventListener('touchstart', this.handleColorWheelTouchStart.bind(this));
          colorWheel.addEventListener('touchmove', this.handleColorWheelTouchMove.bind(this));
          colorWheel.addEventListener('touchend', this.handleColorWheelTouchEnd.bind(this));
          
          // Keyboard events for CSS color wheel
          colorWheel.addEventListener('keydown', this.handleColorWheelKeyDown.bind(this));
          
          // Click event for CSS color wheel
          colorWheel.addEventListener('click', this.handleColorWheelClick.bind(this));
        }

        if (valueSlider) {
          valueSlider.addEventListener('input', this.handleValueSliderChange.bind(this));
        }

        // Initialize color wheel
        this.updateColorWheel();
      }

      handleColorWheelMouseDown(e) {
        e.preventDefault();
        this.isDragging = true;
        this.setHueFromCoords(e.clientX, e.clientY);
      }

      handleColorWheelMouseMove(e) {
        if (this.isDragging) {
          e.preventDefault();
          this.setHueFromCoords(e.clientX, e.clientY);
        }
      }

      handleColorWheelMouseUp(e) {
        this.isDragging = false;
      }

      handleColorWheelClick(e) {
        e.preventDefault();
        this.setHueFromCoords(e.clientX, e.clientY);
        this.updateColorWheel();
      }

      handleColorWheelTouchStart(e) {
        e.preventDefault();
        this.isDragging = true;
        const touch = e.touches[0];
        this.setHueFromCoords(touch.clientX, touch.clientY);
      }

      handleColorWheelTouchMove(e) {
        if (this.isDragging) {
          e.preventDefault();
          const touch = e.touches[0];
          this.setHueFromCoords(touch.clientX, touch.clientY);
        }
      }

      handleColorWheelTouchEnd(e) {
        this.isDragging = false;
      }

      handleColorWheelKeyDown(e) {
        const step = 15;
        switch (e.key) {
          case 'ArrowLeft':
            e.preventDefault();
            this.selectedHue = (this.selectedHue - step + 360) % 360;
            this.updateColorWheel();
            break;
          case 'ArrowRight':
            e.preventDefault();
            this.selectedHue = (this.selectedHue + step) % 360;
            this.updateColorWheel();
            break;
          case 'ArrowUp':
            e.preventDefault();
            this.selectedLightness = Math.min(90, this.selectedLightness + 5);
            this.updateColorWheel();
            break;
          case 'ArrowDown':
            e.preventDefault();
            this.selectedLightness = Math.max(25, this.selectedLightness - 5);
            this.updateColorWheel();
            break;
        }
      }

      handleValueSliderChange(e) {
        this.selectedLightness = parseInt(e.target.value);
        this.updateColorWheel();
      }

      updateColorWheel() {
        const valueSlider = document.getElementById('valueSlider');
        
        const hslColor = `hsl(${this.selectedHue}, ${this.selectedSaturation}%, ${this.selectedLightness}%)`;
        const hexColor = Utils.hslToHex(this.selectedHue, this.selectedSaturation, this.selectedLightness);
        
        const colorScreen = document.getElementById('screen-color');
        if (colorScreen && this.colorHasBeenSelected) {
          colorScreen.style.backgroundColor = hexColor;
        }
        
        if (valueSlider) {
          valueSlider.style.background = `linear-gradient(to right,
            hsl(${this.selectedHue}, ${this.selectedSaturation}%, 20%), 
            hsl(${this.selectedHue}, ${this.selectedSaturation}%, 90%))`;
        }
      }

      setHueFromCoords(x, y) {
        const colorWheel = document.getElementById('colorWheelCanvas');
        const indicator = document.getElementById('colorIndicator');
        const rect = colorWheel.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        const dx = x - centerX;
        const dy = y - centerY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        const radius = rect.width / 2;

        // Calculate angle for hue
        let angle = Math.atan2(dy, dx) * 180 / Math.PI;
        if (angle < 0) angle += 360;
        
        const rawHue = Math.round((angle + 90) % 360);
        this.selectedHue = (rawHue + 25) % 360;
        
        // Calculate saturation based on distance from center
        const baseSaturation = Math.min(100, (distance / radius) * 100);
        this.selectedSaturation = Math.min(Math.round(baseSaturation + 5), 100);

        if (distance > radius) {
          const clampedDistance = radius;
          const clampedX = centerX + (dx / distance) * clampedDistance;
          const clampedY = centerY + (dy / distance) * clampedDistance;
          this.selectedSaturation = 100;
          
          if (indicator) {
            const container = colorWheel.parentElement;
            const containerRect = container.getBoundingClientRect();
            const relativeX = clampedX + rect.left - containerRect.left;
            const relativeY = clampedY + rect.top - containerRect.top;
            indicator.style.left = `${relativeX}px`;
            indicator.style.top = `${relativeY}px`;
          }
        } else {
          if (indicator) {
            const container = colorWheel.parentElement;
            const containerRect = container.getBoundingClientRect();
            const relativeX = x + rect.left - containerRect.left;
            const relativeY = y + rect.top - containerRect.top;
            indicator.style.left = `${relativeX}px`;
            indicator.style.top = `${relativeY}px`;
          }
        }
        
        this.colorHasBeenSelected = true;
        this.updateColorWheel();
      }

      handleKeyDown(event) {
        if (event.key === 'Escape') {
          const currentScreen = document.querySelector('.screen.active');
          if (currentScreen) {
            const currentId = currentScreen.id;
            if (currentId === 'screen-quote') {
              this.uiService.showScreen('screen-portal');
            } else if (currentId === 'screen-color') {
              this.uiService.showScreen('screen-quote');
            } else if (currentId === 'screen-quilt') {
              this.uiService.showScreen('screen-color');
            }
          }
        }
      }

      handleWindowResize() {
        // Update quilt dimensions when window is resized
        if (this.blocks && this.blocks.length > 0) {
          this.renderQuilt();
        }
      }

      setupFloatingAdminButton() {
        const adminBtn = document.getElementById('floatingAdminBtn');
        if (adminBtn) {
          // Check if current user is admin (only show for you)
          const isAdmin = this.isCurrentUserAdmin();
          
          if (isAdmin) {
            adminBtn.style.display = 'flex';
            // Only add event listener if not already added
            if (!adminBtn.hasAttribute('data-admin-initialized')) {
              adminBtn.addEventListener('click', () => {
                this.showAdminMenu();
              });
              adminBtn.setAttribute('data-admin-initialized', 'true');
            }
          } else {
            adminBtn.style.display = 'none';
          }
        }
      }

      isCurrentUserAdmin() {
        // Add your specific user ID or admin check here
        const currentUserId = this.currentUserId;
        
        // Option 1: Check for specific user ID (replace with your actual user ID)
        const adminUserIds = [
          // Add your user ID here - you can find it in localStorage or console
          'your_user_id_here'
        ];
        
        // Option 2: Check for admin flag in localStorage
        const isAdminFlag = localStorage.getItem('ourDailyIsAdmin') === 'true';
        
        // Option 3: Check for specific admin email/identifier
        const adminEmails = [
          // Add your email or identifier here
          'your_email@example.com'
        ];
        
        // For now, let's use a simple check - you can modify this
        return isAdminFlag || adminUserIds.includes(currentUserId);
      }

      // Admin helper methods
      enableAdminMode() {
        localStorage.setItem('ourDailyIsAdmin', 'true');
        this.uiService.showToast('Admin mode enabled');
        // Refresh the admin button
        this.setupFloatingAdminButton();
      }

      disableAdminMode() {
        // Add confirmation to prevent accidental disabling
        if (!confirm('Are you sure you want to disable admin mode? You can re-enable it with enableAdmin().')) {
          return;
        }
        
        localStorage.removeItem('ourDailyIsAdmin');
        this.uiService.showToast('Admin mode disabled');
        // Hide the admin button
        const adminBtn = document.getElementById('floatingAdminBtn');
        if (adminBtn) {
          adminBtn.style.display = 'none';
        }
      }

      showAdminMenu() {
        // Create admin menu with quick actions
        const menu = document.createElement('div');
        menu.className = 'admin-menu';
        menu.innerHTML = `
          <div class="admin-menu-content">
            <h3>Admin Controls</h3>
            <button onclick="app.handleTestAddBlock()">Add Random Block</button>
            <button onclick="app.handleShowMyPiece()">Show My Piece</button>
            <button onclick="app.handleTestDifferentUser()">Simulate Different User</button>
            <button onclick="app.resetQuiltForNewDay()">Reset Quilt</button>
            <button onclick="this.parentElement.parentElement.remove()">Close</button>
          </div>
        `;
        
        // Style the menu
        menu.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          border: 2px solid #000;
          border-radius: 8px;
          padding: 20px;
          z-index: 1001;
          box-shadow: 0 8px 16px rgba(0,0,0,0.3);
          min-width: 250px;
        `;
        
        // Style the content
        const content = menu.querySelector('.admin-menu-content');
        content.style.cssText = `
          display: flex;
          flex-direction: column;
          gap: 10px;
        `;
        
        // Style the buttons
        const buttons = menu.querySelectorAll('button');
        buttons.forEach(btn => {
          btn.style.cssText = `
            padding: 8px 16px;
            border: 1px solid #000;
            background: #fff;
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
          `;
        });
        
        // Add close on background click
        menu.addEventListener('click', (e) => {
          if (e.target === menu) {
            menu.remove();
          }
        });
        
        document.body.appendChild(menu);
      }

      initializeUI() {
        const dateText = document.getElementById("date-text");
        if (dateText) {
          dateText.textContent = Utils.formatDate();
        }
        this.quoteService.displayQuote();
        this.uiService.showScreen('screen-portal');
      }

      setupAutoTransition() {
        const currentScreen = document.querySelector('.screen.active');
        if (currentScreen && currentScreen.id === 'screen-portal') {
          // Increase delay for mobile devices and add better error handling
          const delay = window.innerWidth <= 768 ? 3000 : 2000;
          
          setTimeout(() => {
            // Check if we're still on the portal screen before transitioning
            const currentScreen = document.querySelector('.screen.active');
            if (currentScreen && currentScreen.id === 'screen-portal') {
              this.autoTransitionFromPortal();
            }
          }, delay);
        }
      }

      async autoTransitionFromPortal() {
        try {
          const hasVisitedBefore = localStorage.getItem('ourDailyHasVisited');
          const lastVisitDate = localStorage.getItem('ourDailyLastVisitDate');
          
          const now = new Date();
          const currentDate = now.toDateString();
          const isNewDay = lastVisitDate !== currentDate;
          
          if (!hasVisitedBefore || isNewDay) {
            localStorage.setItem('ourDailyHasVisited', 'true');
            localStorage.setItem('ourDailyLastVisitDate', currentDate);
            
            if (isNewDay) {
              await this.resetQuiltForNewDay();
            }
            
            this.uiService.showScreen('screen-welcome');
            
            // Longer delay for mobile before showing quote
            const quoteDelay = window.innerWidth <= 768 ? 2500 : 1500;
            setTimeout(() => {
              this.uiService.showScreen('screen-quote');
            }, quoteDelay);
          } else {
            this.uiService.showScreen('screen-quote');
          }
        } catch (error) {
          this.logger.error('‚ùå Auto transition failed:', error);
          // Fallback: show quote screen
          this.uiService.showScreen('screen-quote');
        }
      }
      
      async resetQuiltForNewDay() {
        const dimensions = Utils.getQuiltDimensions();
        this.blocks = [{ x: 0, y: 0, width: dimensions.width, height: dimensions.height, color: CONFIG.APP.defaultColor }];
        this.contributorCount = 1;
        
        try {
          await this.dataService.saveQuilt(this.blocks, this.contributorCount);
        } catch (error) {
          this.logger.warn('‚ö†Ô∏è Failed to clear Firebase data for new day:', error);
        }
        
        this.renderQuilt();
        this.updateSquareCounter();
      }

      async loadQuilt() {
        try {
          const data = await this.dataService.loadQuilt();
          this.blocks = data.blocks;
          this.contributorCount = data.contributorCount;
          
          // Ensure we always have at least one block
          if (!this.blocks || this.blocks.length === 0) {
            const dimensions = Utils.getQuiltDimensions();
            this.blocks = [{ x: 0, y: 0, width: dimensions.width, height: dimensions.height, color: CONFIG.APP.defaultColor }];
            this.contributorCount = 1;
          }
        } catch (error) {
          this.logger.error('‚ùå Failed to load quilt:', error);
          this.errorHandler.handleError(error, 'loadQuilt');
          const dimensions = Utils.getQuiltDimensions();
          this.blocks = [{ x: 0, y: 0, width: dimensions.width, height: dimensions.height, color: CONFIG.APP.defaultColor }];
          this.contributorCount = 1;
        }
      }



      async saveQuilt() {
        try {
          await this.dataService.saveQuilt(this.blocks, this.contributorCount);
        } catch (error) {
          this.errorHandler.handleError(error, 'saveQuilt');
          throw error;
        }
      }

      renderQuilt() {
        // Ensure quilt fits within available space
        this.ensureQuiltFits();
        
        this.renderer.renderBlocks(this.blocks);
        this.updateSquareCounter();
      }

      ensureQuiltFits() {
        if (!this.blocks || this.blocks.length === 0) return;
        
        // Get the actual available space using visual viewport
        const hasVisualViewport = window.visualViewport && window.visualViewport.width > 0;
        const availableWidth = hasVisualViewport ? window.visualViewport.width : window.innerWidth;
        const availableHeight = hasVisualViewport ? window.visualViewport.height : window.innerHeight;
        
        // Find the current bounds of all blocks
        const minX = Math.min(...this.blocks.map(b => b.x));
        const minY = Math.min(...this.blocks.map(b => b.y));
        const maxX = Math.max(...this.blocks.map(b => b.x + b.width));
        const maxY = Math.max(...this.blocks.map(b => b.y + b.height));
        
        const currentWidth = maxX - minX;
        const currentHeight = maxY - minY;
        
        // Calculate optimal scale to fit the quilt within available space
        const scaleX = availableWidth / currentWidth;
        const scaleY = availableHeight / currentHeight;
        const optimalScale = Math.min(scaleX, scaleY, 1); // Don't scale up beyond 1x
        
        // Store the scale factor for use in rendering (don't modify original blocks)
        this.quiltScale = optimalScale;
        

      }

      updateSquareCounter() {
        const counterElement = document.getElementById('squareCounter');
        if (counterElement) {
          counterElement.textContent = this.blocks.length;
        }
      }



      splitBlock(blockIndex, newColor) {
        try {
          
          if (!Utils.validateHexColor(newColor)) {
            throw new Error(`Invalid color format: ${newColor}`);
          }

          if (blockIndex < 0 || blockIndex >= this.blocks.length) {
            throw new Error(`Block index ${blockIndex} is out of bounds (array length: ${this.blocks.length})`);
          }

          const block = this.blocks[blockIndex];
          if (!block) {
            throw new Error(`Block at index ${blockIndex} not found`);
          }

          const splitRatio = 0.3 + Math.random() * 0.4;
          
          // Always split vertically
          const splitX = block.width * splitRatio;
          const block1 = { ...block, width: splitX };
          const block2 = { ...block, x: block.x + splitX, width: block.width - splitX, color: newColor };
          
          this.blocks.splice(blockIndex, 1, block1, block2);
          const newBlockIndex = blockIndex + 1; // Point to the second piece (block2)
          
          // Set the last added index in the renderer for animation
          this.renderer.setLastAddedIndex(newBlockIndex);
          
          return true;
        } catch (error) {
          this.logger.error('Split block failed:', error);
          return false;
        }
      }

      async handleAddColor() {
        try {
          const selectedColor = Utils.hslToHex(this.selectedHue, this.selectedSaturation, this.selectedLightness);
          
          if (!selectedColor) {
            this.logger.warn('No color selected');
            return;
          }

          if (!Utils.validateHexColor(selectedColor)) {
            this.logger.error(`Invalid color generated: ${selectedColor}`);
            return;
          }

          // Ensure blocks are initialized
          if (!this.blocks || this.blocks.length === 0) {
            const dimensions = Utils.getQuiltDimensions();
            this.blocks = [{ x: 0, y: 0, width: dimensions.width, height: dimensions.height, color: CONFIG.APP.defaultColor }];
            this.contributorCount = 1;
          }

          // Pick a random block to split
          const indexToSplit = Math.floor(Math.random() * this.blocks.length);

          const success = this.splitBlock(indexToSplit, selectedColor);
          
          if (success) {
            this.contributorCount++;
            
            // Save to Firebase
            await this.saveQuilt();
            
            // Render updated quilt
            this.renderQuilt();
            
            this.uiService.showToast('Color added to the quilt!');
            this.uiService.showScreen('screen-quilt');
          }
          
        } catch (error) {
          this.errorHandler.handleError(error, 'handleAddColor');
        }
      }

      async handleShare() {
        try {
          
          const quiltSVG = document.getElementById('quilt');
          if (!quiltSVG) {
            throw new Error('Quilt SVG not found');
          }

          // Generate image from SVG
          const canvas = await html2canvas(quiltSVG, {
            backgroundColor: '#f6f4f1',
            scale: 2,
            useCORS: true,
            allowTaint: true
          });

          // Convert to blob
          canvas.toBlob(async (blob) => {
            try {
              // Create share data
              const shareData = {
                title: 'Our Daily Quilt',
                text: `Check out today's community quilt with ${this.contributorCount} contributors!`,
                files: [new File([blob], 'quilt.png', { type: 'image/png' })]
              };

              // Try native sharing
              if (navigator.share && navigator.canShare(shareData)) {
                await navigator.share(shareData);
                this.uiService.showToast('Shared successfully!');
              } else {
                // Fallback: download image
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `quilt-${new Date().toISOString().split('T')[0]}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.uiService.showToast('Quilt downloaded!');
              }
            } catch (error) {
              this.logger.error('Share failed:', error);
              this.uiService.showToast('Share failed. Please try again.');
            }
          }, 'image/png', 0.9);

        } catch (error) {
          this.errorHandler.handleError(error, 'shareFlow');
        }
      }

      async handleTestAddBlock() {
        const testColors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd'];
        const randomColor = testColors[Math.floor(Math.random() * testColors.length)];
        
        // Pick a random block to split
        const indexToSplit = Math.floor(Math.random() * this.blocks.length);

        const success = this.splitBlock(indexToSplit, randomColor);
        
        if (success) {
          this.contributorCount++;
          this.renderQuilt();
          await this.saveQuilt();
          
          this.uiService.showToast(`Added test block: ${randomColor}`);
        }
      }

      handleShowMyPiece() {
        // In block-based system, we can highlight the last added block
        if (this.blocks.length > 1) {
          this.uiService.showToast('Your piece is highlighted!');
          // The renderer already handles highlighting the last added block
        } else {
          this.uiService.showToast('No pieces found for current user');
        }
      }

      handleTestDifferentUser() {
        // Generate a new user ID
        this.currentUserId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        localStorage.setItem('ourDailyUserId', this.currentUserId);
        
        this.uiService.showToast('Switched to different user');

      }
    }

    // Global function to update contributor counter
    window.updateContributorCounter = function(contributorCount) {
      const thankYouElement = document.querySelector('.thank-you-message');
      if (thankYouElement) {
        if (contributorCount === 1) {
          thankYouElement.textContent = "Thank you for adding your block! Look what we're making together <3";
        } else {
          thankYouElement.textContent = `Thank you for adding your block! Look what ${contributorCount} people are making together <3`;
        }
      }
    };

    // Initialize the application
    document.addEventListener('DOMContentLoaded', async () => {
      const app = new SimplifiedQuiltApp();
      await app.initialize();
      
      // Expose app globally for testing
      window.app = app;
      
      // Global test functions
      window.addTestBlock = () => app.handleTestAddBlock();
      window.showMyPiece = () => app.handleShowMyPiece();
      window.switchUser = () => app.handleTestDifferentUser();
      window.shareQuilt = () => app.handleShare();
      
      // Admin console commands
      window.enableAdmin = () => app.enableAdminMode();
      window.disableAdmin = () => app.disableAdminMode();
      

    });
  </script>
</body>
</html> 